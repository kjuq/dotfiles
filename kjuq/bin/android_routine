#!/usr/bin/env bash

set -u

# Parse Arguments
loop=false
pic=false
doc=false
while getopts "lpda" opt; do
	case "$opt" in
	l)
		loop=true
		;;
	p)
		pic=true
		;;
	d)
		doc=true
		;;
	a)
		pic=true
		doc=true
		;;
	*)
		exit 1
		;;
	esac
done
shift "$((OPTIND - 1))"

checkhealth() {
	if [ -z "${TERMUX_VERSION:-}" ]; then
		echo 'This environment is not Termux. Quit' 1>&2
		echo '============================================='
		exit 1
	fi
	if ! command -v rsync &>/dev/null; then
		echo "Error: 'rsync' not found" 1>&2
		echo '============================================='
		exit 1
	fi
	if ! command -v cloudflared &>/dev/null; then
		echo "Error: 'cloudflared' not found" 1>&2
		echo '============================================='
		exit 1
	fi
	if [ ! -e "$HOME/.cloudflared/cert.pem" ]; then
		echo 'Error: Not logged in to Cloudflare. Do `cloudflared login`' 1>&2
		echo '============================================='
		exit 1
	fi
	if ! echo ';o;' | gpg --passphrase-fd 0 --pinentry-mode=loopback -o $PREFIX/tmp/pass_dummy --yes $PASSWORD_STORE_DIR/__dummy/__is_decryption_success.gpg > /dev/null 2>&1; then
		# if ! pass __dummy/__is_decryption_success > /dev/null 2>&1; then
		echo 'Error: passphrase of `gpg-agent` is not entered' 1>&2
		echo '============================================='
		exit 1
	fi
}

sshsetup() {
	echo '#*# Register SSH keys #*#'
	ssh-setup
}

# Copy local image to remote
copyimg() {
	echo -e '\n\n#*# Sending local images to remote #*#'
	user="kjuq"
	host="ssh.kjuq.dpdns.org" # Cloudflare
	if timeout 1 ping -c 1 100.100.100.100 >/dev/null; then
		host="kun150p" # Tailscale
		echo 'Use Tailscale connection'
	else
		echo 'Use Cloudflare connection'
	fi
	remote_home='/mnt/extstrg/storage'
	local_path="$HOME/storage/dcim/"
	remote_path='pictures/_android/dcim/'
	rsync -av --exclude='.thumbnails' "$local_path" "$user@$host:$remote_home/$remote_path/"
	local_path="$HOME/storage/pictures/"
	remote_path='pictures/_android/pictures/'
	rsync -av --exclude='.thumbnails' "$local_path" "$user@$host:$remote_home/$remote_path/"
}

# Pull remote doc
pulldoc() {
	echo -e '\n\n#*# Git Pull #*#'
	git -C "$KJUQ_DOCS" pull
	if [ ! $? -eq 0 ]; then
		echo '`git pull` failed' 1>&2
		exit 1
	fi
}

# Push local doc
pushdoc() {
	echo -e '\n\n#*# Git Add #*#'
	git -C "$KJUQ_DOCS" add -A
	if [ ! $? -eq 0 ]; then
		echo '`git add -A` failed' 1>&2
		exit 1
	fi
	echo -e '\n\n#*# Git Commit #*#'
	if [ ! -z "$(git -C "$KJUQ_DOCS" diff --cached --name-only)" ]; then # Check if at least one file is staged
		git -C "$KJUQ_DOCS" commit -m 'Update from termux'
		if [ ! $? -eq 0 ]; then
			echo '`git commit` failed' 1>&2
			exit 1
		fi
	else
		echo 'Nothing was added. Skip committing'
	fi
	echo -e '\n\n#*# Git Push #*#'
	git -C "$KJUQ_DOCS" push
	if [ ! $? -eq 0 ]; then
		echo '`git push` failed' 1>&2
		exit 1
	fi
}

exec_all() {
	echo -e "\n\n============ $(date '+%Y-%m-%d_%H-%M-%S') ============"
	checkhealth
	sshsetup
	[ "$pic" = true ] && copyimg
	[ "$doc" = true ] && pulldoc
	[ "$doc" = true ] && pushdoc
	echo -e '\n\nEverything done!'
	echo '============================================='
}

main() {
	exec_all 2>&1 | tee -a $XDG_CACHE_HOME/android_routine.log
}

if [ $loop = true ]; then
	while true; do
		exec_all
		sleep $((60 * 60 * 24))
	done
else
	exec_all

fi
